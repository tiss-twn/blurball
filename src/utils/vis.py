import os
import os.path as osp
from typing import Tuple
from tqdm import tqdm
import cv2
import numpy as np
import matplotlib.pyplot as plt
import subprocess
import sys

from utils import Center


def draw_frame(
    img_or_path,
    center: Center,
    color: Tuple,
    radius: int = 5,
    thickness: int = -1,
    angle=None,
    l=None,
):
    if osp.isfile(img_or_path):
        img = cv2.imread(img_or_path)
    else:
        img = img_or_path

    xy = center.xy
    visi = center.is_visible
    if visi:
        x, y = xy
        x, y = int(x), int(y)
        img = cv2.circle(img, (x, y), radius, color, thickness=thickness)
        if angle is not None:
            if l != 0:
                angle_rad = np.deg2rad(angle)
                x1 = int(x + l * np.cos(angle_rad))
                y1 = int(y + l * np.sin(angle_rad))
                x2 = int(x - l * np.cos(angle_rad))
                y2 = int(y - l * np.sin(angle_rad))
                cv2.line(img, (x1, y1), (x2, y2), (0, 255, 0), 2)

    return img


def gen_video(video_path, vis_dir, resize=1.0, fps=30.0, fourcc="avc1"):
    fnames = os.listdir(vis_dir)
    fnames.sort()
    h, w, _ = cv2.imread(osp.join(vis_dir, fnames[0])).shape
    im_size = (int(w * resize), int(h * resize))
    
    # Use mp4v initially (most reliable with OpenCV)
    # We'll convert to H.264 afterwards using ffmpeg
    temp_video_path = video_path.replace('.mp4', '_temp.mp4')
    fourcc_code = cv2.VideoWriter_fourcc(*"mp4v")
    out = cv2.VideoWriter(temp_video_path, fourcc_code, fps, im_size)
    
    if not out.isOpened():
        print(f"Error: Could not initialize video writer")
        return

    for fname in tqdm(fnames):
        im_path = osp.join(vis_dir, fname)
        im = cv2.imread(im_path)
        if im is not None:
            im = cv2.resize(im, None, fx=resize, fy=resize)
            out.write(im)
        else:
            print("COuldn't read image")
            print(fname)
    
    out.release()
    
    # Convert to H.264 using ffmpeg
    print("Converting to H.264...")
    try:
        # Use ffmpeg to convert to H.264
        cmd = [
            'ffmpeg', '-y',  # -y to overwrite output file
            '-i', temp_video_path,
            '-c:v', 'libx264',  # Use H.264 codec
            '-preset', 'medium',  # Balance between speed and compression
            '-crf', '23',  # Quality (18-28, lower = better quality)
            '-pix_fmt', 'yuv420p',  # For compatibility
            video_path
        ]
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        if result.returncode == 0:
            print(f"Successfully converted to H.264: {video_path}")
            # Remove temp file
            os.remove(temp_video_path)
        else:
            print(f"Warning: ffmpeg conversion failed, keeping mp4v version")
            print(f"Error: {result.stderr}")
            # Rename temp to final if ffmpeg failed
            os.rename(temp_video_path, video_path)
    except FileNotFoundError:
        print("Warning: ffmpeg not found, keeping mp4v version")
        os.rename(temp_video_path, video_path)
    except Exception as e:
        print(f"Warning: Conversion failed ({e}), keeping mp4v version")
        if os.path.exists(temp_video_path):
            os.rename(temp_video_path, video_path)
